name: Auto Update last_index.txt and Process Next 10 Words

on:
  workflow_dispatch:  # 手动触发工作流，或设置为定时触发（cron）  
  schedule:
    - cron: '0 0 * * *'  # 每天00:00自动触发一次（可选）

jobs:
  update_index:
    runs-on: ubuntu-latest  # 使用 GitHub 提供的 Ubuntu 环境

    steps:
      # 检出当前仓库内容
      - name: Checkout repository
        uses: actions/checkout@v2  # 拉取当前仓库代码

      # 安装 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'  # 设置 Python 版本

      # 安装依赖并处理 Excel 文件，更新索引
      - name: Process Excel file, update index, and push changes
        run: |
          # 打印当前索引值
          echo "Reading current index from last_index.txt..."

          # 读取 last_index.txt 中记录的上次索引
          last_index=$(cat last_index.txt)
          echo "Current last_index: $last_index"
          
          # 设置读取数据的文件路径
          data_file="data.xlsx"
          
          # 安装必要的依赖
          pip install pandas openpyxl

          # 使用 Python 来读取 Excel 文件并处理数据
          python -c "
import pandas as pd

# 读取 Excel 文件
df = pd.read_excel('$data_file')

# 从上次索引开始，提取接下来的 10 行
start_index = $last_index
end_index = start_index + 10
data_to_send = df.iloc[start_index:end_index]

# 输出发送的数据（这里只是一个示例，实际上应该发送邮件）
for index, row in data_to_send.iterrows():
    print(f'Sending data: {row[0]} - {row[1]} - {row[2]}')  # 示例：输出数据的单词、读音、意思

# 更新索引为下次的起始行
new_index = end_index
print(f'New index to update: {new_index}')
" > output.txt

          # 读取 Python 脚本输出的 new_index（即下次要发送的起始行）
          new_index=$(tail -n 1 output.txt)

          # 打印新索引
          echo "New index to update last_index.txt: $new_index"

          # 更新 last_index.txt 文件
          echo $new_index > last_index.txt

          # 打印更新后的文件内容
          echo "Updated last_index.txt:"
          cat last_index.txt
          
          # 配置 Git 用户信息
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # 提交并推送更新
          git add last_index.txt
          git commit -m "Auto update last_index.txt to $new_index"
          git push origin main  # 推送到 GitHub 仓库的 main 分支
