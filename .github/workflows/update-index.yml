name: Update last_index.txt

on:
  push:
    paths:
      - last_index.txt  # 仅当 last_index.txt 文件发生变化时触发
    branches:
      - main  # 只在 main 分支上执行

jobs:
  update_index:
    runs-on: ubuntu-latest  # 使用 GitHub 提供的 Ubuntu 环境

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2  # 拉取当前仓库代码

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'  # 设置 Python 版本

      - name: Read last_index.txt, process next 10 lines, and update the index
        run: |
          # 读取 last_index.txt 中记录的上次索引
          last_index=$(cat last_index.txt)
          
          # 设置读取数据的文件路径
          data_file="data.xlsx"
          
          # 读取 Excel 文件中的数据
          pip install pandas openpyxl
          python -c "
import pandas as pd
df = pd.read_excel('$data_file')

# 从上次索引开始，提取接下来的 10 行
start_index = $last_index
end_index = start_index + 10
data_to_send = df.iloc[start_index:end_index]

# 生成邮件内容（仅作示例，可以根据需要调整）
for index, row in data_to_send.iterrows():
    print(f'发送数据: {row[0]} - {row[1]} - {row[2]}')  # 示例：发送的单词、读音、意思

# 更新索引为下次的起始行
new_index = end_index
print(f'更新索引为: {new_index}')
" > output.txt

          # 读取 Python 脚本输出的 new_index（即下次要发送的起始行）
          new_index=$(tail -n 1 output.txt)

          # 更新 last_index.txt 文件
          echo $new_index > last_index.txt
          
          # 配置 Git 用户信息
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # 提交并推送更新
          git add last_index.txt
          git commit -m "Auto update last_index.txt to $new_index"
          git push origin main  # 推送到 GitHub 仓库的 main 分支
